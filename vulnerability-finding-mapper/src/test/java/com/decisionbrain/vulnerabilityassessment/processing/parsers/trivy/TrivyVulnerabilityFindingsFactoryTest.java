package com.decisionbrain.vulnerabilityassessment.processing.parsers.trivy;

import com.decisionbrain.vulnerabilityassessment.model.exception.InvalidJsonException;
import com.decisionbrain.vulnerabilityassessment.model.exception.MissingResourceException;
import com.decisionbrain.vulnerabilityassessment.model.trivy.TrivyReport;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.ScanType;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.Severity;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.Tools;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.VulnerabilityFinding;
import com.decisionbrain.vulnerabilityassessment.processing.trivy.TrivyVulnerabilityFindingsFactory;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.springframework.core.io.FileSystemResource;
import org.springframework.core.io.Resource;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.junit.jupiter.api.Assertions.*;

class TrivyVulnerabilityFindingsFactoryTest {
    static List<VulnerabilityFinding> reports;

    @BeforeAll
    static void initialiseVulnerabilities() throws Exception {
        TrivyReport trivyReport = TrivyReport.Factory.fromFile(new File("src/test/resources/trivyfiles/trivy-report-sample.json"));
        TrivyVulnerabilityFindingsFactory trivyVulnerabilityFindingsFactory = new TrivyVulnerabilityFindingsFactory(trivyReport);
        reports = trivyVulnerabilityFindingsFactory.createReports();
    }


    @Test
    void sizeTest() {
        assertThat(reports)
                .isNotNull()
                .hasSize(136);
    }

    @Test
    void fileNameTest() {
        assertThat(reports.get(1).getFileName()).isEqualTo("demo-gene-sample-dev-docker-group.decisionbrain.cloud/app/backend-service:4.0.3-fp1 (redhat 9.0)");
    }

    @Test
    void severityTest() {
        assertThat(reports.get(1).getReportedSeverity()).isEqualTo(Severity.MEDIUM);
    }

    @Test
    void toolTest() {
        assertThat(reports.get(1).getTool()).isEqualTo(Tools.TRIVY);
    }

    @Test
    void affectedCodeSourceLocationTest() {
        assertThat(reports.get(1).getAffectedSourceCodeLocation()).isEqualTo("avahi-libs");
    }

    @Test
    void cveIdTest() {
        assertThat(reports.get(1).getCveId()).isEqualTo("CVE-2021-3502");
    }

    @Test
    void scanTypeTest() {
        assertThat(reports.get(1).getScanType()).isEqualTo(ScanType.SAST);
    }

    @Test
    void testVulnerabilityDescription() {
        assertTrue(reports.get(1).getVulnerabilityDescription().contains("avahi: reachable assertion in avahi_s_host_name_resolver_start when trying to resolve badly-formatted hostnames"));
    }

    @Test
    void invalidFormatTest()  {
        assertThatThrownBy(() -> {
            TrivyReport.Factory.fromFile(new File("src/test/resources/invalid-format.json"));
        }).isInstanceOf(InvalidJsonException.class);
    }


    @Test
    void inputStreamTest() throws IOException{
        List<VulnerabilityFinding> vulnerabilityFindingsReports;

        String resourcePath = "/trivyfiles/trivy-report-sample.json";
        InputStream is = getClass().getResourceAsStream(resourcePath);
        TrivyReport trivyReport = TrivyReport.Factory.fromInputStream(is);
        TrivyVulnerabilityFindingsFactory trivyVulnerabilityFindingsFactory = new TrivyVulnerabilityFindingsFactory(trivyReport);
        vulnerabilityFindingsReports = trivyVulnerabilityFindingsFactory.createReports();

        assertThat(vulnerabilityFindingsReports)
                .isNotNull()
                .hasSize(136);
    }


    @Test
    void resourceTest() throws Exception {
        List<VulnerabilityFinding> vulnerabilityFindingsReports;

        Resource resource = new FileSystemResource("src/test/resources/trivyfiles/trivy-report-sample.json");
        TrivyReport trivyReport = TrivyReport.Factory.fromResource(resource);
        TrivyVulnerabilityFindingsFactory trivyVulnerabilityFindingsFactory = new TrivyVulnerabilityFindingsFactory(trivyReport);
        vulnerabilityFindingsReports = trivyVulnerabilityFindingsFactory.createReports();

        assertThat(vulnerabilityFindingsReports)
                .isNotNull()
                .hasSize(136);
    }

    @Test
    void missingResourceTest() {
        Resource resource = new FileSystemResource("src/test/resources/trivyfiles/notfound.json");
        assertThatThrownBy(() -> {
            TrivyReport.Factory.fromResource(resource);
        }).isInstanceOf(MissingResourceException.class);
    }

}