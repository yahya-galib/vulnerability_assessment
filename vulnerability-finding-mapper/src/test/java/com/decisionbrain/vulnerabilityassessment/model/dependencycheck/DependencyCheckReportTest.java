package com.decisionbrain.vulnerabilityassessment.model.dependencycheck;

import com.decisionbrain.vulnerabilityassessment.model.exception.InvalidJsonException;
import com.decisionbrain.vulnerabilityassessment.model.exception.MissingResourceException;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.ScanType;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.Tools;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.VulnerabilityFinding;
import com.decisionbrain.vulnerabilityassessment.processing.dependencycheck.DependencyCheckVulnerabilityFindingsFactory;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.springframework.core.io.FileSystemResource;
import org.springframework.core.io.Resource;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.time.Month;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

class DependencyCheckReportTest {
    static List<VulnerabilityFinding> reports;
    @BeforeAll
    static void initializeVulnerability() throws Exception {
        DependencyCheckReport dependencyCheckReport =  DependencyCheckReport.Factory.fromFile(new File("src/test/resources/dependencycheckfiles/dependency-check-report-full.json"));
        DependencyCheckVulnerabilityFindingsFactory dependencyCheckVulnerabilityFindingsFactory = new DependencyCheckVulnerabilityFindingsFactory(dependencyCheckReport);
        reports = dependencyCheckVulnerabilityFindingsFactory.createReports();
    }

    @Test
    void sizeTest() {
        assertThat(reports)
                .isNotNull()
                .hasSize(37);
    }

    @Test
    void fileNameTest(){
        assertThat(reports.get(0).getFileName()).isEqualTo("apache-mime4j-0.6.jar");
        assertThat(reports.get(15).getFileName()).isEqualTo("resteasy-client-3.13.2.Final.jar");
    }

    @Test
    void affectedSourceCodeLocation() {
        assertThat(reports.get(0).getAffectedSourceCodeLocation()).isEqualTo("pkg:maven/org.apache.james/apache-mime4j@0.6");
    }

    @Test
    void cveIdTest(){
        assertThat(reports.get(0).getCveId()).isEqualTo("CVE-2021-38542");
    }

    @Test
    void toolsTest() {
        assertThat(reports.get(0).getTool()).isEqualTo(Tools.OWASP_DEPENDENCY_CHECK);
    }

    @Test
    void scanTypeTest(){
        assertThat(reports.get(0).getScanType()).isEqualTo(ScanType.SAST_OSS);
    }

    @Test
    void scanDateTest() {
        assertThat(reports.get(0).getScanDate()).hasYear(2022)
                .hasMonth(Month.DECEMBER)
                .hasDayOfMonth(16)
                .hasHour(17)
                .hasMinute(42)
                .hasSecond(01);
    }

    @Test
    void invalidFormatTest(){
        assertThatThrownBy(() -> {
            DependencyCheckReport.Factory.fromFile(new File("src/test/resources/invalid-format.json"));
        }).isInstanceOf(InvalidJsonException.class);
    }

    @Test
    void inputStreamTest() throws IOException{
        List<VulnerabilityFinding> vulnerabilityFindingsReports;

        String resourcePath = "/dependencycheckfiles/dependency-check-report-full.json";
        InputStream is = getClass().getResourceAsStream(resourcePath);
        DependencyCheckReport dependencyCheckReport = DependencyCheckReport.Factory.fromInputStream(is);
        DependencyCheckVulnerabilityFindingsFactory dependencyCheckVulnerabilityFindingsFactory = new DependencyCheckVulnerabilityFindingsFactory(dependencyCheckReport);
        vulnerabilityFindingsReports = dependencyCheckVulnerabilityFindingsFactory.createReports();

        assertThat(vulnerabilityFindingsReports)
                .isNotNull()
                .hasSize(37);
    }

    @Test
    void resourceTest() throws Exception {
        List<VulnerabilityFinding> vulnerabilityFindingsReports;

        Resource resource = new FileSystemResource("src/test/resources/dependencycheckfiles/dependency-check-report-full.json");
        DependencyCheckReport dependencyCheckReport = DependencyCheckReport.Factory.fromResource(resource);
        DependencyCheckVulnerabilityFindingsFactory dependencyCheckVulnerabilityFindingsFactory = new DependencyCheckVulnerabilityFindingsFactory(dependencyCheckReport);
        vulnerabilityFindingsReports = dependencyCheckVulnerabilityFindingsFactory.createReports();

        assertThat(vulnerabilityFindingsReports)
                .isNotNull()
                .hasSize(37);

    }

    @Test
    void missingResourceTest() {
        Resource resource = new FileSystemResource("src/test/resources/dependencycheckfiles/notfound.json");
        assertThatThrownBy(() -> {
            DependencyCheckReport.Factory.fromResource(resource);
        }).isInstanceOf(MissingResourceException.class);

    }
}