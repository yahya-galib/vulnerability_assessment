package com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding;

import com.decisionbrain.vulnerabilityassessment.model.dependencycheck.DependencyCheckReport;
import com.decisionbrain.vulnerabilityassessment.model.exception.InvalidJsonException;
import com.decisionbrain.vulnerabilityassessment.model.exception.OverwriteExistingFileException;
import com.decisionbrain.vulnerabilityassessment.model.trivy.TrivyReport;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.SerializationFeature;
import org.junit.jupiter.api.Test;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Stream;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatExceptionOfType;
import static org.junit.jupiter.api.Assertions.assertEquals;

class VulnerabilityFindingsTest {

    @Test
    void storeTrivyReportWithOverWriteTest() throws IOException, OverwriteExistingFileException {
        Path path = Paths.get("src/test/resources/reports/reports.json");

        VulnerabilityFinding vulnerabilityFinding = new VulnerabilityFinding();
        vulnerabilityFinding.setFileName("demo-gene-sample-dev-docker-group.decisionbrain.cloud/app/backend-service:4.0.3-fp1 (redhat 9.0)");
        vulnerabilityFinding.setScanType(ScanType.SAST);
        vulnerabilityFinding.setTool(Tools.TRIVY);
        vulnerabilityFinding.setReportedSeverity(Severity.MEDIUM);
        vulnerabilityFinding.setAffectedSourceCodeLocation("avahi-libs");
        vulnerabilityFinding.setCveId("CVE-2021-3468");

        List<VulnerabilityFinding> listVulnerabilityFinding = new ArrayList<>();
        listVulnerabilityFinding.add(vulnerabilityFinding);

        VulnerabilityFindings vulnerabilityFindings = new VulnerabilityFindings(listVulnerabilityFinding);
        vulnerabilityFindings.store(path, OverwriteBehavior.REPLACE);

        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.configure(SerializationFeature.INDENT_OUTPUT, true);

        String expected = objectMapper.writeValueAsString(vulnerabilityFindings.getFindings());
        String actual = Files.readString(path);

        assertEquals(expected, actual);
    }

    @Test
    void storeDependencyCheckReportWithOverWriteTest() throws IOException, OverwriteExistingFileException {
        Path path = Paths.get("src/test/resources/reports/reports.json");

        VulnerabilityFinding vulnerabilityFinding = new VulnerabilityFinding();
        vulnerabilityFinding.setFileName("apache-mime4j-0.6.jar");
        vulnerabilityFinding.setScanType(ScanType.SAST_OSS);
        vulnerabilityFinding.setTool(Tools.OWASP_DEPENDENCY_CHECK);
        vulnerabilityFinding.setReportedSeverity(Severity.LOW);
        vulnerabilityFinding.setAffectedSourceCodeLocation("pkg:maven\"/org.apache.james\"/apache-mime4j@0.6");
        vulnerabilityFinding.setCveId("CVE-2021-38542");

        List<VulnerabilityFinding> listVulnerabilityFinding = new ArrayList<>();
        listVulnerabilityFinding.add(vulnerabilityFinding);

        VulnerabilityFindings vulnerabilityFindings = new VulnerabilityFindings(listVulnerabilityFinding);
        vulnerabilityFindings.store(path, OverwriteBehavior.REPLACE);

        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.configure(SerializationFeature.INDENT_OUTPUT, true);

        String expected = objectMapper.writeValueAsString(vulnerabilityFindings.getFindings());
        String actual = Files.readString(path);

        assertEquals(expected, actual);
    }


    @Test
    void storeDependencyCheckReportWithOutOverWriteTest() {
        Path path = Paths.get("src/test/resources/reports/reports.json");

        VulnerabilityFinding vulnerabilityFinding = new VulnerabilityFinding();
        vulnerabilityFinding.setFileName("demo-gene-sample-dev-docker-group.decisionbrain.cloud/app/backend-service:4.0.3-fp1 (redhat 9.0)");
        vulnerabilityFinding.setScanType(ScanType.SAST);
        vulnerabilityFinding.setTool(Tools.TRIVY);
        vulnerabilityFinding.setReportedSeverity(Severity.MEDIUM);
        vulnerabilityFinding.setAffectedSourceCodeLocation("avahi-libs");
        vulnerabilityFinding.setCveId("CVE-2021-3468");

        List<VulnerabilityFinding> listVulnerabilityFinding = new ArrayList<>();
        listVulnerabilityFinding.add(vulnerabilityFinding);

        VulnerabilityFindings vulnerabilityFindings = new VulnerabilityFindings(listVulnerabilityFinding);

        assertThatExceptionOfType(OverwriteExistingFileException.class)
                .isThrownBy( () -> {
                    vulnerabilityFindings.store(path, OverwriteBehavior.ERROR);
                });
    }

    @Test
    void fromReportDependencyCheckTest() throws InvalidJsonException, IOException {
        DependencyCheckReport dependencyCheckReport = DependencyCheckReport.Factory.fromFile(new File("src/test/resources/dependencycheckfiles/dependency-check-report-full.json"));
        assertThat(VulnerabilityFindings.Factory.fromReport(dependencyCheckReport))
                .isNotNull()
                .isInstanceOf(VulnerabilityFindings.class);
    }


    @Test
    void fromReportTrivyTest() throws InvalidJsonException, IOException {
        TrivyReport trivyReport = TrivyReport.Factory.fromFile(new File("src/test/resources/trivyfiles/trivy-report-full.json"));
        assertThat(VulnerabilityFindings.Factory.fromReport(trivyReport))
                .isNotNull()
                .isInstanceOf(VulnerabilityFindings.class);
    }

    @Test
    void testAppendVulnerabilitiesInOnFile() throws IOException, OverwriteExistingFileException {
        Path path = Paths.get("src/test/resources/reports/append-report.json");

        VulnerabilityFinding vulnerabilityFinding = new VulnerabilityFinding();
        vulnerabilityFinding.setFileName("apache-mime4j-0.6.jar");
        vulnerabilityFinding.setScanType(ScanType.SAST_OSS);
        vulnerabilityFinding.setTool(Tools.OWASP_DEPENDENCY_CHECK);
        vulnerabilityFinding.setReportedSeverity(Severity.LOW);
        vulnerabilityFinding.setAffectedSourceCodeLocation("pkg:maven\"/org.apache.james\"/apache-mime4j@0.6");
        vulnerabilityFinding.setCveId("CVE-2021-38542");

        List<VulnerabilityFinding> listVulnerabilityFinding = new ArrayList<>();
        listVulnerabilityFinding.add(vulnerabilityFinding);

        VulnerabilityFindings vulnerabilityFindings = new VulnerabilityFindings(listVulnerabilityFinding);
        vulnerabilityFindings.store(path, OverwriteBehavior.REPLACE);



        VulnerabilityFinding vulnerabilityFinding2 = new VulnerabilityFinding();
        vulnerabilityFinding2.setFileName("demo-gene-sample-dev-docker-group.decisionbrain.cloud/app/backend-service:4.0.3-fp1 (redhat 9.0)");
        vulnerabilityFinding2.setScanType(ScanType.SAST);
        vulnerabilityFinding2.setTool(Tools.TRIVY);
        vulnerabilityFinding2.setReportedSeverity(Severity.MEDIUM);
        vulnerabilityFinding2.setAffectedSourceCodeLocation("avahi-libs");
        vulnerabilityFinding2.setCveId("CVE-2021-3468");

        List<VulnerabilityFinding> listVulnerabilityFinding2 = new ArrayList<>();
        listVulnerabilityFinding2.add(vulnerabilityFinding2);

        VulnerabilityFindings vulnerabilityFindings2 = new VulnerabilityFindings(listVulnerabilityFinding2);
        vulnerabilityFindings2.store(path, OverwriteBehavior.APPEND);

        List<VulnerabilityFinding> mergedVulnerabilities = new ArrayList<>();

        Stream.of(listVulnerabilityFinding2,listVulnerabilityFinding).forEach(mergedVulnerabilities::addAll);

        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.configure(SerializationFeature.INDENT_OUTPUT, true);

        String expected = objectMapper.writeValueAsString(mergedVulnerabilities);
        String actual = Files.readString(path);

        assertEquals(expected, actual);

    }

    @Test
    public void testFromFile() throws IOException, InvalidJsonException {
        var vulnerabilityFindings = VulnerabilityFindings.Factory.fromFile(new File("src/test/resources/reports/vulnerability-findings.json"));
        assertThat(vulnerabilityFindings).isNotNull();
        assertThat(vulnerabilityFindings.getFindings()).hasSize(6);
    }
}