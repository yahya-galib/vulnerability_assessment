package com.decisionbrain.vulnerabilityassessment.processing.trivy;

import com.decisionbrain.vulnerabilityassessment.model.trivy.Result;
import com.decisionbrain.vulnerabilityassessment.model.trivy.TrivyReport;
import com.decisionbrain.vulnerabilityassessment.model.trivy.VulnerabilityTrivy;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.ScanType;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.Severity;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.Tools;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.VulnerabilityFinding;
import com.decisionbrain.vulnerabilityassessment.processing.api.VulnerabilityFindingsFactory;

import java.util.ArrayList;
import java.util.List;

/**
 * Extract vulnerability findings from Trivy report.
 * @see: https://trivy.dev/
 */
public class TrivyVulnerabilityFindingsFactory implements VulnerabilityFindingsFactory {

    private final TrivyReport trivyReport;

    public TrivyVulnerabilityFindingsFactory(TrivyReport trivyReport) {
        this.trivyReport = trivyReport;
    }

    /**
     * This method create a list of VulnerabilityFinding objects by iterating over the vulnerabilities in a TrivyReport instance.
     * @return a list of VulnerabilityFinding objects representing the vulnerabilities in the TrivyReport.
     */
    @Override
    public List<VulnerabilityFinding> createReports() {

        List<VulnerabilityFinding> reports = new ArrayList<>();

        if(trivyReport.getResults() != null){
            for(Result result : trivyReport.getResults()){
                if(!result.getVulnerabilities().isEmpty()){
                    for(VulnerabilityTrivy vulnerabilityTrivy : result.getVulnerabilities()) {
                        VulnerabilityFinding vulnerabilityFinding = new VulnerabilityFinding();
                        vulnerabilityFinding.setFileName(result.getTarget());
                        vulnerabilityFinding.setCveId(vulnerabilityTrivy.getVulnerabilityID());
                        vulnerabilityFinding.setReportedSeverity(Severity.fromString(vulnerabilityTrivy.getSeverity()));
                        vulnerabilityFinding.setTool(Tools.TRIVY);
                        vulnerabilityFinding.setScanType(ScanType.SAST);
                        vulnerabilityFinding.setAffectedSourceCodeLocation(vulnerabilityTrivy.getPkgName());
                        vulnerabilityFinding.setVulnerabilityDescription("Description: "+vulnerabilityTrivy.getDescription().concat(" Title: " + vulnerabilityTrivy.getTitle()));

                        reports.add(vulnerabilityFinding);
                    }
                }
            }
        }
        return reports;

    }
}
