package com.decisionbrain.vulnerabilityassessment.processing.dependencycheck;

import com.decisionbrain.vulnerabilityassessment.model.dependencycheck.Dependency;
import com.decisionbrain.vulnerabilityassessment.model.dependencycheck.DependencyCheckReport;
import com.decisionbrain.vulnerabilityassessment.model.dependencycheck.Package;
import com.decisionbrain.vulnerabilityassessment.model.dependencycheck.VulnerabilityDependencyCheck;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.ScanType;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.Severity;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.Tools;
import com.decisionbrain.vulnerabilityassessment.model.vulnerabilityfinding.VulnerabilityFinding;
import com.decisionbrain.vulnerabilityassessment.processing.api.VulnerabilityFindingsFactory;

import java.util.ArrayList;
import java.util.List;

/**
 * Extract vulnerability findings from OWASP Dependency Check report.
 * @see: https://owasp.org/www-project-dependency-check
 */

public class DependencyCheckVulnerabilityFindingsFactory implements VulnerabilityFindingsFactory {

    private final DependencyCheckReport dependencyCheckReport;
    public DependencyCheckVulnerabilityFindingsFactory(DependencyCheckReport dependencyCheckReport) {
        this.dependencyCheckReport = dependencyCheckReport;
    }

    /**
     * This method generate a list of VulnerabilityFinding objects based on the contents of the DependencyCheckReport object.
     * @return a List of VulnerabilityFinding objects
     */
    @Override
    public List<VulnerabilityFinding> createReports() {
        List<VulnerabilityFinding> report = new ArrayList<>();

        if(!dependencyCheckReport.getDependencies().isEmpty()) {
            for (Dependency dependency : dependencyCheckReport.getDependencies()) {
                if (!dependency.getVulnerabilities().isEmpty()) {
                    for (VulnerabilityDependencyCheck vulnerabilityDependencyCheck : dependency.getVulnerabilities()) {
                        VulnerabilityFinding vulnerabilityFinding = new VulnerabilityFinding();
                        vulnerabilityFinding.setFileName(dependency.getFileName());
                        vulnerabilityFinding.setScanDate(dependencyCheckReport.getProjectInfo().getReportDate());
                        vulnerabilityFinding.setScanType(ScanType.SAST_OSS);
                        vulnerabilityFinding.setTool(Tools.OWASP_DEPENDENCY_CHECK);
                        vulnerabilityFinding.setCveId(vulnerabilityDependencyCheck.getName());
                        vulnerabilityFinding.setVulnerabilityDescription(vulnerabilityDependencyCheck.getDescription());
                        String affectedCodeSourceLocation = "";
                        for (Package packages : dependency.getPackages()) {
                            affectedCodeSourceLocation = String.join(",", packages.getId());
                        }
                        vulnerabilityFinding.setAffectedSourceCodeLocation(affectedCodeSourceLocation);
                        vulnerabilityFinding.setReportedSeverity(Severity.fromString(vulnerabilityDependencyCheck.getSeverity()));
                        report.add(vulnerabilityFinding);
                    }
                }
            }
        }
        return report;
    }
}
