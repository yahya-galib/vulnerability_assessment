package com.decisionbrain.vulnerabilityassessment.model.dependencycheck;

import com.decisionbrain.vulnerabilityassessment.model.exception.InvalidJsonException;
import com.decisionbrain.vulnerabilityassessment.model.exception.MissingResourceException;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import org.springframework.core.io.Resource;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.List;
import java.util.Objects;

/**
 * Representation of a JSON report from OWASP Dependency Check.
 * @see: https://owasp.org/www-project-dependency-check
 */


public class DependencyCheckReport {
    ProjectInfo projectInfo;
    List<Dependency> dependencies;

    public ProjectInfo getProjectInfo() {
        return projectInfo;
    }

    public void setProjectInfo(ProjectInfo projectInfo) {
        this.projectInfo = projectInfo;
    }

    public List<Dependency> getDependencies() {
        return dependencies;
    }

    public void setDependencies(List<Dependency> dependencies) {
        this.dependencies = dependencies;
    }


    public static class Factory {

        private static final ObjectMapper mapper;

        static {
           mapper = new ObjectMapper();
            mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
            mapper.configure(DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES, false);
            mapper.registerModule(new JavaTimeModule());
        }

        private Factory() { }

        /**
         * This method takes in a file as input and returns a DependencyCheckReport object after reading and validating its contents.
         * @param reportFile the file to be read and parsed.
         * @return a DependencyCheckReport object parsed from the input file.
         * @throws Exception  if the input file is null or if the contents of the file are invalid JSON.
         */
        public static DependencyCheckReport fromFile(File reportFile) throws InvalidJsonException, IOException {
            Objects.requireNonNull(reportFile, "Function parameter reportFile does not support null.");
            if (!validate(reportFile)) {
                throw new InvalidJsonException("Json invalid");
            }
            return mapper.readValue(reportFile, DependencyCheckReport.class);
        }

        /**
         *  This method takes in a InputStream as input and returns a DependencyCheckReport object by deserializing the InputStream using an ObjectMapper instance.
         * @param is the InputStream to be read and deserialized.
         * @return a DependencyCheckReport object representing the deserialized contents of the InputStream.
         * @throws IOException if an I/O error occurs while reading from the InputStream.
         */
        public static DependencyCheckReport fromInputStream(InputStream is) throws IOException {
            Objects.requireNonNull(is, "Function parameter is does not support null.");
            return mapper.readValue(is, DependencyCheckReport.class);
        }

        /**
         * This method takes in a Resource as input and returns a DependencyCheckReport object by deserializing the Resource.
         * @param resource the Resource to be read and deserialized.
         * @return  a DependencyCheckReport object representing the deserialized contents of the Resource.
         * @throws IOException  if an I/O error occurs while reading from the Resource's InputStream.
         * @throws  MissingResourceException if the input Resource does not exist.
         */
        public static DependencyCheckReport fromResource(Resource resource) throws MissingResourceException, IOException {
            Objects.requireNonNull(resource, "Function parameter resource does not support null.");
            if(!resource.exists()){
                throw new MissingResourceException("Resource not found");
            }
            return fromInputStream(resource.getInputStream());
        }

        /**
         * This method takes in a file as input by trying to parse its contents as JSON.
         * @param reportFile the file to be validated.
         * @return true if the contents of the file can be parsed as valid JSON, false otherwise.
         */
        private static boolean validate(File reportFile) {
            try {
                mapper.readTree(reportFile);
                return true;
            }catch (Exception e){
                return false;
            }
        }
    }
}
