package com.decisionbrain.vulnerabilityassessment.model.trivy;

import com.decisionbrain.vulnerabilityassessment.model.exception.InvalidJsonException;
import com.decisionbrain.vulnerabilityassessment.model.exception.MissingResourceException;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import org.springframework.core.io.Resource;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.List;
import java.util.Objects;

/**
 * Representation of a JSON report from Trivy.
 * @see: https://trivy.dev/
 */
public class TrivyReport {
    @JsonProperty("Results") private List<Result> results;

    public List<Result> getResults() {
        return results;
    }

    public void setResults(List<Result> results) {
        this.results = results;
    }

    public static class Factory {

        private static final ObjectMapper objectMapper;

        static {
            objectMapper = new ObjectMapper();
            objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
            objectMapper.configure(DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES, false);
            objectMapper.registerModule(new JavaTimeModule());
        }


        private Factory() {}

        /**
         *  This method takes in a file as input and returns a TrivyReport object after reading and validating its contents.
         * @param reportFile the file to be read and parsed.
         * @return a TrivyReport object parsed from the input file.
         * @throws Exception  if the input file is null or if the contents of the file are invalid JSON.
         */
        public static TrivyReport fromFile(File reportFile) throws InvalidJsonException, IOException {
            Objects.requireNonNull(reportFile, "Function parameter reportFile does not support null.");
            if(!validate(reportFile)){
                throw new InvalidJsonException("Json invalid");
            }
            return objectMapper.readValue(reportFile, TrivyReport.class);
        }

        /**
         * This method takes in a InputStream as input and returns a TrivyReport object by deserializing the InputStream using an ObjectMapper instance.
         * @param is the InputStream to be read and deserialized.
         * @return a TrivyReport  object representing the deserialized contents of the InputStream.
         * @throws IOException if an I/O error occurs while reading from the InputStream.
         */

        public static TrivyReport fromInputStream(InputStream is)throws IOException {
            Objects.requireNonNull(is, "Function parameter is does not support null.");
            return objectMapper.readValue(is, TrivyReport.class);
        }

        /**
         * This method takes in a Resource as input and returns a TrivyReport object by deserializing the Resource.
         * @param resource the Resource to be read and deserialized.
         * @return a TrivyReport object representing the deserialized contents of the Resource.
         * @throws IOException  if an I/O error occurs while reading from the Resource's InputStream.
         * @throws MissingResourceException  if the input Resource does not exist.
         */
        public static TrivyReport fromResource(Resource resource) throws MissingResourceException, IOException {
            Objects.requireNonNull(resource, "Function parameter resource does not support null.");
            if(!resource.exists()){
                throw new MissingResourceException("Resource not found");
            }
            return fromInputStream(resource.getInputStream());
        }

        /**
         * This method takes in a file as input by trying to parse its contents as JSON.
         * @param file the file to be validated.
         * @return true if the contents of the file can be parsed as valid JSON, false otherwise.
         */
        private static boolean validate(File file) {
            try {
                objectMapper.readTree(file);
                return true;
            } catch (Exception e) {
                return false;
            }
        }
    }
}
